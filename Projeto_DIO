
import requests
import json
import uuid
import os

# Função para traduzir texto usando o Azure Translator
def traduzir_texto(texto: str, idioma_destino: str, idioma_origem: str = None) -> str:
    """
    Traduz um texto utilizando o serviço Azure Translator.

    Args:
        texto (str): O texto a ser traduzido.
        idioma_destino (str): O código do idioma para o qual o texto será traduzido (ex: 'pt', 'en', 'es').
        idioma_origem (str, optional): O código do idioma de origem. Se None, a API tentará detectar automaticamente.

    Returns:
        str: O texto traduzido, ou None se ocorrer um erro.
    """
    #  Obtém as credenciais do Azure das variáveis de ambiente para segurança
    subscription_key = os.getenv('AZURE_TRANSLATOR_KEY')
    endpoint = os.getenv('AZURE_TRANSLATOR_ENDPOINT')
    region = os.getenv('AZURE_TRANSLATOR_REGION')

    # Verifica se as credenciais foram configuradas
    if not subscription_key or not endpoint or not region:
        print(" ERRO: As credenciais do Azure (AZURE_TRANSLATOR_KEY, AZURE_TRANSLATOR_ENDPOINT, AZURE_TRANSLATOR_REGION) não estão configuradas como variáveis de ambiente.")
        print("Por favor, defina-as antes de executar a aplicação.")
        return None

    #  Constrói a URL da API
    path = '/translate?api-version=3.0'
    params = f'&to={idioma_destino}'
    if idioma_origem:
        params += f'&from={idioma_origem}'
    constructed_url = endpoint + path + params

    #  Cabeçalhos da requisição
    headers = {
        'Ocp-Apim-Subscription-Key': subscription_key,
        'Ocp-Apim-Subscription-Region': region, # Necessário para alguns serviços do Azure
        'Content-type': 'application/json',
        'X-ClientTraceId': str(uuid.uuid4()) # ID único para rastreamento da requisição
    }

    #  Corpo da requisição (o texto a ser traduzido)
    body = [{'text': texto}]

    try:
        # Envia a requisição POST para a API do Azure Translator
        response = requests.post(constructed_url, headers=headers, json=body)
        response.raise_for_status() # Lança um HTTPError para respostas de status ruins (4xx ou 5xx)

        # Processa a resposta
        response_data = response.json()
        # A resposta é uma lista, onde cada item corresponde a um texto enviado no body
        # E dentro de cada item, há uma lista de 'translations'
        traducoes = [item['translations'][0]['text'] for item in response_data if 'translations' in item and len(item['translations']) > 0]

        return traducoes[0] if traducoes else None

    except requests.exceptions.HTTPError as http_err:
        print(f"ERRO HTTP: {http_err} - Resposta: {response.text}")
        return None
    except requests.exceptions.ConnectionError as conn_err:
        print(f"ERRO DE CONEXÃO: Verifique sua conexão com a internet ou o endpoint do Azure. Detalhes: {conn_err}")
        return None
    except requests.exceptions.Timeout as timeout_err:
        print(f"ERRO DE TEMPO LIMITE: A requisição para o Azure Translator excedeu o tempo limite. Detalhes: {timeout_err}")
        return None
    except requests.exceptions.RequestException as req_err:
        print(f" ERRO GERAL NA REQUISIÇÃO: Ocorreu um erro ao chamar a API do Azure Translator. Detalhes: {req_err}")
        return None
    except json.JSONDecodeError:
        print(f" ERRO AO DECODIFICAR JSON: A resposta da API não é um JSON válido. Resposta recebida: {response.text}")
        return None
    except Exception as e:
        print(f" ERRO INESPERADO: {e}")
        return None

# Função principal para a interface de linha de comando
def main():
    print(" Aplicação de Tradução de Texto com Azure Translator \n")

    texto_original = input(" Digite o texto a ser traduzido: ")
    # O .strip() ajuda a remover espaços em branco extras ou quebras de linha que o usuário possa digitar acidentalmente.
    if not texto_original.strip():
        print(" Texto não pode ser vazio.")
        return

    idioma_origem_input = input(" Digite o código do idioma de origem (ex: 'en', 'pt', 'es') ou pressione Enter para auto-detectar: ")
    idioma_origem = idioma_origem_input.strip() if idioma_origem_input.strip() else None

    idioma_destino_input = input("Digite o código do idioma de destino (ex: 'pt', 'en', 'es'): ")
    idioma_destino = idioma_destino_input.strip()

    if not idioma_destino:
        print(" O código do idioma de destino é obrigatório.")
        return

    print(f"\n Iniciando tradução...")

    # Chama a função de tradução
    traducao = traduzir_texto(texto_original, idioma_destino, idioma_origem)

    # Exibe o resultado ou uma mensagem de erro
    if traducao:
        print("\n--- Resultado da Tradução ---")
        print(f" Texto original ({idioma_origem if idioma_origem else 'Auto-detectado'}): {texto_original}")
        print(f"Texto traduzido ({idioma_destino}): {traducao}")
        print("----------------------------")
    else:
        print("\n Não foi possível realizar a tradução. Verifique as mensagens de erro acima e suas configurações.")

if __name__ == "__main__":
    main()
